const DATA_URL = 'data/items.json';

const els = {
  grid: document.getElementById('grid'),
  empty: document.getElementById('empty'),
  meta: document.getElementById('meta'),
  search: document.getElementById('search'),
  type: document.getElementById('typeFilter'),
  tag: document.getElementById('tagFilter'),
  time: document.getElementById('timeFilter'),
  sort: document.getElementById('sortFilter'),
  refresh: document.getElementById('refreshBtn'),
  toggleTheme: document.getElementById('toggleTheme'),
};

const state = {
  raw: { items: [] },
  q: '',
  type: '',
  tag: '',
  time: '', // '', '7d','30d','1y','5y'
  sort: 'hot', // 'latest' | 'hot'
  read: new Set(JSON.parse(localStorage.getItem('read-ids') || '[]')),
};

function saveRead() {
  localStorage.setItem('read-ids', JSON.stringify([...state.read]));
}

function fmtDate(iso) {
  if (!iso) return '';
  const d = new Date(iso);
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${y}-${m}-${day}`;
}

function escapeHtml(s) { return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

function render(items) {
  els.grid.innerHTML = '';
  els.empty.classList.toggle('hidden', items.length > 0);
  for (const it of items) {
    const card = document.createElement('article');
    card.className = 'card' + (state.read.has(it.id) ? ' read' : '');
    const typeBadge = `<span class="badge">${it.type}</span>`;
    const tags = (it.tags || []).map(t => `<span class="badge">${escapeHtml(t)}</span>`).join('');
    card.innerHTML = `
      <div class="meta-line">
        ${typeBadge}
        <span>${escapeHtml(it.source || '')}</span>
        <span>Â·</span>
        <span>${fmtDate(it.publishedAt)}</span>
      </div>
      <h3><a href="${it.url}" target="_blank" rel="noopener">${escapeHtml(it.title)}</a></h3>
      <div class="summary">${escapeHtml(it.summary || '')}</div>
      <div class="tags">${tags}</div>
    `;
    card.addEventListener('click', (e) => {
      // mark as read when user clicks inside card (but keep link behavior)
      state.read.add(it.id); saveRead(); card.classList.add('read');
    });
    els.grid.appendChild(card);
  }
}

function filterItems() {
  const q = state.q.trim().toLowerCase();
  const now = Date.now();
  let cutoff = 0;
  if (state.time === '7d') cutoff = now - 7 * 24 * 3600 * 1000;
  else if (state.time === '30d') cutoff = now - 30 * 24 * 3600 * 1000;
  else if (state.time === '1y') cutoff = new Date(new Date().getFullYear() - 1, new Date().getMonth(), new Date().getDate()).getTime();
  else if (state.time === '5y') cutoff = new Date(new Date().getFullYear() - 5, 0, 1).getTime();

  const filtered = state.raw.items.filter(it => {
    const byType = !state.type || it.type === state.type;
    const byTag = !state.tag || (it.tags || []).includes(state.tag);
    const byQ = !q || (it.title + ' ' + (it.summary||'')).toLowerCase().includes(q);
    const t = it.publishedAt ? new Date(it.publishedAt).getTime() : now;
    const byTime = cutoff === 0 || (t >= cutoff);
    return byType && byTag && byQ && byTime;
  });
  const ordered = sortItems(filtered, state.sort);
  render(ordered);
  els.meta.textContent = `å…?${filtered.length} æ¡ï¼ˆæ¥æºæ€»è®¡ï¼?{state.raw.count}ï¼Œç”Ÿæˆæ—¶é—´ï¼š${state.raw.generatedAt || ''}ï¼‰`;
}

async function loadData(force) {
  const url = force ? `${DATA_URL}?_=${Date.now()}` : DATA_URL;
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error('åŠ è½½æ•°æ®å¤±è´¥');
    const data = await res.json();
    // å¦‚æžœæ•°æ®ä¸ºç©ºï¼Œå°è¯•ä½¿ç”¨ç§å­æ¼”ç¤ºæ•°æ?    if (!data || !Array.isArray(data.items) || data.items.length === 0) {
      const seedEl = document.getElementById('seed-data');
      if (seedEl?.textContent) {
        state.raw = JSON.parse(seedEl.textContent);
        // ä½¿ç”¨æ¼”ç¤ºæ•°æ®æ—¶ï¼Œæ”¾å®½æ—¶é—´èŒƒå›´ä»¥ç¡®ä¿å¯è§?        state.time = state.time || '5y';
        if (els.time) els.time.value = state.time;
      } else {
        state.raw = data || { items: [] };
      }
    } else {
      state.raw = data;
    }
    filterItems();
  } catch (e) {
    // fetch å¤±è´¥ï¼ˆä¾‹å¦‚é€šè¿‡ file:// æ‰“å¼€ï¼‰æ—¶ï¼Œä½¿ç”¨å†…ç½®æ¼”ç¤ºæ•°æ?    const seedEl = document.getElementById('seed-data');
    if (seedEl?.textContent) {
      state.raw = JSON.parse(seedEl.textContent);
      state.time = state.time || '5y';
      if (els.time) els.time.value = state.time;
      filterItems();
    } else {
      throw e;
    }
  }
}

function setupEvents() {
  els.search.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { state.q = e.target.value; filterItems(); }
  });
  els.type.addEventListener('change', (e) => { state.type = e.target.value; filterItems(); });
  els.tag.addEventListener('change', (e) => { state.tag = e.target.value; filterItems(); });
  els.time.addEventListener('change', (e) => { state.time = e.target.value; filterItems(); });
  if (els.sort) els.sort.addEventListener('change', (e) => { state.sort = e.target.value; filterItems(); });
  els.refresh.addEventListener('click', async () => {
    els.refresh.disabled = true; els.refresh.textContent = 'åˆ·æ–°ä¸­â€?;
    try { await loadData(true); } finally { els.refresh.disabled = false; els.refresh.textContent = 'åˆ·æ–°'; }
  });
  els.toggleTheme.addEventListener('click', () => {
    const cur = document.documentElement.dataset.theme;
    document.documentElement.dataset.theme = cur === 'light' ? 'dark' : 'light';
  });
}

(async function init() {
  setupEvents();
  // é»˜è®¤ï¼šè¿‘30å¤?+ çƒ­é—¨ä¼˜å…ˆï¼ˆè‡ªåŠ¨å‡ºçŽ°â€œæœ€è¿‘çƒ­é—¨â€ï¼‰
  if (!state.time) state.time = '30d';
  if (!state.sort) state.sort = 'hot';
  if (els.time) els.time.value = state.time;
  if (els.sort) els.sort.value = state.sort;
  try { await loadData(false); } catch (e) { console.error(e); els.empty.classList.remove('hidden'); }
})();

function sortItems(items, sort) {
  const now = Date.now();
  if (sort === 'latest') {
    return [...items].sort((a, b) => new Date(b.publishedAt || 0) - new Date(a.publishedAt || 0));
  }
  function hotScore(it) {
    const t = it.publishedAt ? new Date(it.publishedAt).getTime() : now;
    const days = Math.max(0, (now - t) / (24 * 3600 * 1000));
    let score = 1 / (1 + days);
    if (it.type === 'paper') score *= 1.12; else if (it.type === 'news') score *= 1.05; else if (it.type === 'video') score *= 1.02;
    const text = ((it.title || '') + ' ' + (it.summary || '')).toLowerCase();
    if (/(survey|ç»¼è¿°)/.test(text)) score *= 1.15;
    if (/(benchmark|dataset|æ•°æ®é›?/.test(text)) score *= 1.10;
    if (/(embodied ai|å…·èº«æ™ºèƒ½)/.test(text)) score *= 1.08;
    if (/(autonomous driving|self-driving|è‡ªåŠ¨é©¾é©¶|è‡ªå‹•é§•é§›)/.test(text)) score *= 1.06;
    return score;
  }
  return [...items].sort((a, b) => hotScore(b) - hotScore(a));
}
